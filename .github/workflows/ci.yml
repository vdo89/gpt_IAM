name: NetAuto CI

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

concurrency:
  group: netauto-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install lint tooling
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: "1"
        run: |
          python -m pip install --upgrade pip
          pip install --requirement requirements-dev.txt

      - name: Install Conftest
        run: |
          version="v0.52.0"
          curl -L "https://github.com/open-policy-agent/conftest/releases/download/${version}/conftest_${version#v}_Linux_x86_64.tar.gz" \
            | tar xz
          install -m 0755 conftest /usr/local/bin/conftest

      - name: Install OPA
        run: |
          version="v0.68.0"
          curl -L -o opa "https://openpolicyagent.org/downloads/${version}/opa_linux_amd64_static"
          install -m 0755 opa /usr/local/bin/opa

      - name: Lint YAML
        run: yamllint .

      - name: Lint playbooks
        run: ansible-lint ansible/site.yml

      - name: Validate intent contracts
        run: conftest test intent/ --policy policy --combine

      - name: Run policy unit tests with coverage
        run: |
          mkdir -p artifacts
          opa test policy --coverage --threshold 90
          opa test policy --coverage --format=json > artifacts/opa-coverage.json

      - name: Upload policy coverage
        uses: actions/upload-artifact@v4
        with:
          name: opa-coverage-${{ github.sha }}
          path: artifacts/opa-coverage.json
          retention-days: 30

  render:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible tooling
        run: |
          python -m pip install --upgrade pip
          pip install --requirement requirements-dev.txt

      - name: Render candidate configuration (pass 1)
        run: |
          mkdir -p artifacts
          ansible-playbook -i ansible/inventory.yml ansible/site.yml --check --diff \
            | tee artifacts/render-pass1.log

      - name: Render candidate configuration (pass 2)
        run: |
          ansible-playbook -i ansible/inventory.yml ansible/site.yml --check --diff \
            | tee artifacts/render-pass2.log

      - name: Verify idempotence
        run: |
          python - <<'PY'
          import re
          import sys
          import pathlib

          summary_pattern = re.compile(r"ok=(?P<ok>\d+).*changed=(?P<changed>\d+).*unreachable=(?P<unreachable>\d+).*failed=(?P<failed>\d+)")
          log = pathlib.Path("artifacts/render-pass2.log").read_text()
          match = summary_pattern.search(log)
          if not match:
            sys.exit("Could not locate Ansible summary in render-pass2.log")
          if any(int(match.group(key)) for key in ("changed", "unreachable", "failed")):
            sys.exit(f"Idempotence check failed with summary: {match.group(0)}")
          print(f"Idempotence verified: {match.group(0)}")
          PY

      - name: Upload render artifacts
        uses: actions/upload-artifact@v4
        with:
          name: render-logs-${{ github.sha }}
          path: artifacts/*.log
          retention-days: 30

  validate_intent:
    needs: render
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install validation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --requirement requirements-dev.txt

      - name: Validate VRF schema
        run: python scripts/validate_intent.py

      - name: Upload intent summary
        uses: actions/upload-artifact@v4
        with:
          name: intent-validation-${{ github.sha }}
          path: artifacts/intent-validation.json
          retention-days: 30

  deploy:
    if: github.event_name == 'workflow_dispatch'
    needs: [render, validate_intent]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install --requirement requirements-dev.txt

      - name: Deploy configuration
        run: |
          ansible-playbook -i ansible/inventory.yml ansible/site.yml \
            | tee artifacts/deploy.log

      - name: Upload deploy artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log-${{ github.sha }}
          path: artifacts/deploy.log
          retention-days: 30
