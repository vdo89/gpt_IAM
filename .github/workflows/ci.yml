name: NetAuto CI

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

concurrency:
  group: netauto-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install lint tooling
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint yamllint jsonschema conftest jinja2

      - name: Show Conftest version
        run: conftest --version

      - name: Lint YAML
        run: yamllint .

      - name: Lint playbooks
        run: ansible-lint ansible/site.yml

      - name: Validate intent contracts
        run: |
          if [ -d policy ]; then
            conftest test intent/
          else
            echo "No policy directory present; skipping Conftest policy checks."
          fi

  render:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible tooling
        run: |
          python -m pip install --upgrade pip
          pip install ansible jinja2

      - name: Render candidate configuration (pass 1)
        run: |
          mkdir -p artifacts
          ansible-playbook -i ansible/inventory.yml ansible/site.yml --check --diff \
            | tee artifacts/render-pass1.log

      - name: Render candidate configuration (pass 2)
        run: |
          ansible-playbook -i ansible/inventory.yml ansible/site.yml --check --diff \
            | tee artifacts/render-pass2.log

      - name: Collect rendered configuration artifacts
        run: |
          mkdir -p artifacts/rendered
          if [ -d /etc/ansible/rendered ]; then
            cp /etc/ansible/rendered/* artifacts/rendered/
          else
            echo "No rendered configs found in /etc/ansible/rendered"
          fi

      - name: Verify idempotence
        run: |
          python - <<'PY'
          import re
          import sys
          import pathlib

          summary_pattern = re.compile(r"ok=(?P<ok>\d+).*changed=(?P<changed>\d+).*unreachable=(?P<unreachable>\d+).*failed=(?P<failed>\d+)")
          log = pathlib.Path("artifacts/render-pass2.log").read_text()
          match = summary_pattern.search(log)
          if not match:
            sys.exit("Could not locate Ansible summary in render-pass2.log")
          if any(int(match.group(key)) for key in ("changed", "unreachable", "failed")):
            sys.exit(f"Idempotence check failed with summary: {match.group(0)}")
          print(f"Idempotence verified: {match.group(0)}")
          PY

      - name: Upload render artifacts
        uses: actions/upload-artifact@v4
        with:
          name: render-output
          path: artifacts/

  validate_intent:
    needs: render
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install validation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema

      - name: Validate intent schemas
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          from typing import Any, Dict, List

          import yaml
          from jsonschema import Draft7Validator

          def load_schema(name: str) -> Dict[str, Any]:
            schema_path = Path("intent/schema") / name
            return json.loads(schema_path.read_text())

          def validate_objects(objects: List[Dict[str, Any]], schema: Dict[str, Any], label: str):
            validator = Draft7Validator(schema)
            issues = []
            for obj in objects:
              for error in validator.iter_errors(obj):
                issues.append({"object": obj.get("name", obj.get("tenant", "<unnamed>")), "error": error.message})
            return issues

          vrf_intent = yaml.safe_load(Path("intent/vrfs.yml").read_text()) or {}
          vrfs = vrf_intent.get("vrfs", [])
          tenants = []
          for path in Path("intent/tenants").glob("*.yml"):
            tenants.append(yaml.safe_load(path.read_text()) or {})

          vrf_issues = validate_objects(vrfs, load_schema("vrf.schema.json"), "vrf")
          tenant_issues = validate_objects(tenants, load_schema("tenant.schema.json"), "tenant")

          summary = {
            "vrfs": {"count": len(vrfs), "issues": vrf_issues},
            "tenants": {"count": len(tenants), "issues": tenant_issues},
          }

          Path("artifacts").mkdir(exist_ok=True)
          Path("artifacts/intent-summary.json").write_text(json.dumps(summary, indent=2))

          all_issues = vrf_issues + tenant_issues
          if all_issues:
            raise SystemExit(f"Intent schema validation failed: {all_issues}")
          print(json.dumps(summary, indent=2))
          PY

      - name: Upload intent summary
        uses: actions/upload-artifact@v4
        with:
          name: intent-validation
          path: artifacts/intent-summary.json

  deploy:
    if: github.event_name == 'workflow_dispatch'
    needs: [render, validate_intent]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible jinja2

      - name: Deploy configuration
        run: |
          ansible-playbook -i ansible/inventory.yml ansible/site.yml \
            | tee artifacts/deploy.log

      - name: Upload deploy artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log
          path: artifacts/deploy.log
