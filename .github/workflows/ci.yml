name: NetAuto CI

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

concurrency:
  group: netauto-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install lint tooling
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint yamllint jsonschema conftest jinja2

      - name: Lint YAML
        run: yamllint .

      - name: Lint playbooks
        run: ansible-lint ansible/site.yml

      - name: Validate intent contracts
        run: |
          if [ -d policy ]; then
            conftest test intent/
          else
            echo "No policy directory present; skipping Conftest policy checks."
          fi

  render:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible tooling
        run: |
          python -m pip install --upgrade pip
          pip install ansible jinja2

      - name: Render candidate configuration (pass 1)
        run: |
          mkdir -p artifacts
          ansible-playbook -i ansible/inventory.yml ansible/site.yml --check --diff \
            | tee artifacts/render-pass1.log

      - name: Render candidate configuration (pass 2)
        run: |
          ansible-playbook -i ansible/inventory.yml ansible/site.yml --check --diff \
            | tee artifacts/render-pass2.log

      - name: Verify idempotence
        run: |
          python - <<'PY'
          import re
          import sys
          import pathlib

          summary_pattern = re.compile(r"ok=(?P<ok>\d+).*changed=(?P<changed>\d+).*unreachable=(?P<unreachable>\d+).*failed=(?P<failed>\d+)")
          log = pathlib.Path("artifacts/render-pass2.log").read_text()
          match = summary_pattern.search(log)
          if not match:
            sys.exit("Could not locate Ansible summary in render-pass2.log")
          if any(int(match.group(key)) for key in ("changed", "unreachable", "failed")):
            sys.exit(f"Idempotence check failed with summary: {match.group(0)}")
          print(f"Idempotence verified: {match.group(0)}")
          PY

      - name: Upload render artifacts
        uses: actions/upload-artifact@v4
        with:
          name: render-logs
          path: artifacts/*.log

  validate_intent:
    needs: render
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install validation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema

      - name: Validate VRF schema
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          import yaml

          intent = yaml.safe_load(Path("intent/vrfs.yml").read_text())
          vrfs = intent.get("vrfs", []) if intent else []
          required = {"name", "l3vni", "import_rt", "export_rt"}
          problems = []
          for vrf in vrfs:
            missing = sorted(required - set(vrf))
            if missing:
              problems.append({"vrf": vrf.get("name", "<unnamed>"), "missing": missing})
          summary = {"count": len(vrfs), "missing_fields": problems}
          Path("artifacts").mkdir(exist_ok=True)
          Path("artifacts/intent-summary.json").write_text(json.dumps(summary, indent=2))
          if problems:
            raise SystemExit(f"VRF schema issues found: {problems}")
          print(json.dumps(summary, indent=2))
          PY

      - name: Upload intent summary
        uses: actions/upload-artifact@v4
        with:
          name: intent-validation
          path: artifacts/intent-summary.json

  deploy:
    if: github.event_name == 'workflow_dispatch'
    needs: [render, validate_intent]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible jinja2

      - name: Deploy configuration
        run: |
          ansible-playbook -i ansible/inventory.yml ansible/site.yml \
            | tee artifacts/deploy.log

      - name: Upload deploy artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log
          path: artifacts/deploy.log
