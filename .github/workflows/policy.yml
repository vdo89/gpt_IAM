name: policy
on:
  pull_request:
    paths:
      - "intent/**.yml"
      - "schemas/**.json"
      - "policy/**.rego"
      - "policy/data/**.json"
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ajv-cli
        run: npm i -g ajv-cli@5

      - name: JSON Schema check (all intents)
        run: |
          ajv validate -s schemas/intent.schema.json -d 'intent/**/*.yml' --strict=true
          ajv validate -s schemas/vrf.schema.json -d 'intent/vrfs.yml' --strict=true
          ajv validate -s schemas/tenant.schema.json -d 'intent/tenants/**/*.yml' --strict=true
          ajv validate -s schemas/allowed_exports.schema.json -d policy/data/allowed_exports.json --strict=true

      - name: Install conftest
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/download/v0.51.0/conftest_Linux_x86_64.tar.gz \
          | tar xz && sudo mv conftest /usr/local/bin/

      - name: OPA unit tests
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.68.0/opa_linux_amd64_static
          install -m 0755 opa /usr/local/bin/opa
          opa test policy --coverage --threshold 90 --verbose

      - name: Conftest on intents (deny on violations)
        run: conftest test intent/ --combine -p policy
